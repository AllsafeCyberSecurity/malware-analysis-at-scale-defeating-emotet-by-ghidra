from __main__ import *

import struct
from itertools import cycle

from ghidra.program.model.listing import CodeUnit

def decrypt_string(enc_data_addr):
    key = getInt(enc_data_addr)
    xored_length = getInt(enc_data_addr.add(4))
    original_length = key ^ xored_length
    enc = getBytes(enc_data_addr.add(8), original_length).tostring()
    return ''.join([chr(ord(k) ^ ord(v)) for k, v in zip(cycle(struct.pack('<I', key)), enc)])


def add_bookmark_comment(addr, comment):
    cu = currentProgram.getListing().getCodeUnitAt(addr)
    createBookmark(addr, "decrypted_str", comment)
    cu.setComment(CodeUnit.EOL_COMMENT, comment)

def get_instructions_before(addr, n=1):
    r = []
    for _ in range(n):
        inst = getInstructionBefore(addr)
        r.append(inst)
        addr = inst.getAddress()
    return r

def is_mov_edx(inst):
    return str(inst).startswith('MOV EDX,0x')

def find_decrypt_string_func():
    ''' **** IMPLEMENT HERE ****
        return list of possible decrypt_string functions
        Hint:
            1. use Version Tracking to compare two samples
            2. use `findBytes` to search instructions/binaries
            3. use `getFunctionContaining` to get function that contains specific address
    '''
    raise NotImplementedError('not implemented')

def main():
    decrypt_string_funcs = find_decrypt_string_func()

    for decrypt_string_func in decrypt_string_funcs:
        print('[*] decrypt_string at {}'.format(decrypt_string_func.getEntryPoint()))
        # get callee address of decrypt_string function
        for xref in getReferencesTo(decrypt_string_func.getEntryPoint()):
            # get instructions before callee address
            insts = get_instructions_before(xref.getFromAddress(), 50)
            
            # find instruction that passes 
            # address of encrypted data via EDX
            for inst in insts:
                if is_mov_edx(inst):
                    # get encrypted data address and decrypt it
                    data_addr = inst.getOpObjects(1)[0].getValue()
                    if data_addr:
                        decrypted_str = decrypt_string(toAddr(data_addr))
                        # add comment
                        print('[*] found at {} : {!r}'.format(inst.getAddress(), decrypted_str))
                        add_bookmark_comment(inst.getAddress(), decrypted_str)


if __name__ == '__main__':
    main()


